apiVersion: v1
kind: Pod
metadata:
  name: fets-pod
  namespace: gai-lina-group
spec:
  nodeSelector:
    nautilus.io/linstor: "true"
  imagePullSecrets:
  - name: gitlab-registry-secret
  containers:
  - name: fets-container
    image: ghcr.io/fets-ai/front-end:1.0.2
    env:
      - name: REPO_PATH
        value: /app/UNETR-BraTS-Synthesis
    command: ["/bin/bash"]
    args:
      - -c
      - |
        apt-get update && apt-get install -y git
        
        git clone https://github.com/tsereda/UNETR-BraTS-Synthesis.git ${REPO_PATH}
        cd ${REPO_PATH}
        
        sudo apt-get update && sudo apt-get install -y p7zip-full wget git
        pip install nibabel numpy torch monai[all]
        
        for dataset in "TrainingData" "ValidationData"; do
          zip_file="/data/ASNR-MICCAI-BraTS2023-GLI-Challenge-${dataset}.zip"
          if [ -f "$zip_file" ]; then
            echo "Extracting ${dataset}..."
            cd /data
            sudo 7z x "$zip_file" -o"/data/"
            if [ -d "/data/ASNR-MICCAI-BraTS2023-GLI-Challenge-${dataset}" ]; then
              sudo chown -R jovyan:jovyan "/data/ASNR-MICCAI-BraTS2023-GLI-Challenge-${dataset}"
              echo "Successfully extracted and set ownership for ${dataset}"
            fi
            cd ${REPO_PATH}
            ln -sf "/data/ASNR-MICCAI-BraTS2023-GLI-Challenge-${dataset}" .
          fi
        done
        
        python scripts/dropout_modality.py \
          --input_dir ASNR-MICCAI-BraTS2023-GLI-Challenge-ValidationData \
          --output_dir pseudo_validation
          
        python scripts/dropout_modality.py --verify --output_dir pseudo_validation
        
        tail -f /dev/null
    volumeMounts:
      - name: data
        mountPath: /data
  
  volumes:
    - name: data
      persistentVolumeClaim:
        claimName: brats2025-2